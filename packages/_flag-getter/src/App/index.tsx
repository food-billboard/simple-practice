import { useCallback, useEffect, useRef } from 'react'
import { useMouse } from 'ahooks'
import {
  Engine,
  Render,
  Runner,
  Body,
  Composite,
  Bodies,
  World,
  Common,
  Composites,
  Query
} from 'matter-js'
// @ts-ignore 
import polyDecomp from 'poly-decomp'
import 'pathseg'
import './index.css'

Common.setDecomp(polyDecomp)

const WORD_MAP = [
  "升官发财", "五福临门",
  ...new Array(100).fill(0).map((item, index) => `${Date.now()}_${Math.random()}_${index}`)
]

const GameCanvas = (props: {}) => {

  const EngineInstance = useRef<Engine>()
  const WorldInstance = useRef<World>()
  const RenderInstance = useRef<Render>()
  const RunnerInstance = useRef<Runner>()

  const sandglassBody = useRef<Body>()

  const clientSize = useRef<{
    width: number
    height: number 
  }>({ width: 0, height: 0 })

  const { clientX } = useMouse()

  // 随机掉落词语
  const createWord = useCallback((options: {
    centerX: number 
    centerY: number 
    width: number 
    height: number
    scale: number  
  }) => {

    const { scale, centerX, centerY, width, height } = options

    const bodyOptions = {
      frictionAir: 0, 
      friction: 0.0001,
      restitution: 0.6
    };

    // x y 几行 几列 行间距 列间距
    Composite.add(WorldInstance.current!, Composites.stack(centerX - width * 0.35, centerY - height * 0.4, 11, 20, 1, 1, function(x: number, y: number) {
        if (Query.point([sandglassBody.current!], { x: x, y: y }).length === 0) {
          const size = 10 * scale
          return Bodies.circle(x, y, size, {
            ...bodyOptions,
            // render: {
            //   sprite: {
            //     texture: '',
            //     xScale: 1,
            //     yScale: 1
            //   }
            // }
          });
        }
    }));
  }, [])

  // 创建初始物体
  const initExtraBody = useCallback((containerWidth: number, containerHeight: number) => {
    const vertexSets = [
      [
        { "x": 652.212953060086, "y": 740.0594425395791 },
        { "x": 371.8058827475859, "y": 740.0594425395791 },
        { "x": 356.3801092926813, "y": 731.504036822683 },
        { "x": 354.28210345071085, "y": 723.770819492704 },
        { "x": 354.28210345071085, "y": 650.4627433208291 },
        { "x": 354.7064709488703, "y": 639.1132979182067 },
        { "x": 357.13318972032795, "y": 620.7146919754806 },
        { "x": 361.56752763431797, "y": 602.6415427712265 },
        { "x": 367.9019597594095, "y": 585.0641246227088 },
        { "x": 376.0848952357126, "y": 568.1594277409378 },
        { "x": 386.1109760824991, "y": 552.1365880755249 },
        { "x": 398.0078852001978, "y": 537.2629585651222 },
        { "x": 411.8133111123396, "y": 523.893915632135 },
        { "x": 427.52581284683475, "y": 512.4951197294059 },
        { "x": 428.3475038413359, "y": 511.993993320829 },
        { "x": 413.2773184601618, "y": 501.31315664327775 },
        { "x": 399.2827598873926, "y": 488.1155765143696 },
        { "x": 387.19925503175983, "y": 473.37277487791215 },
        { "x": 376.99065781872997, "y": 457.4500133482281 },
        { "x": 368.62658606212864, "y": 440.62220967686807 },
        { "x": 362.1082980756117, "y": 423.1029141930405 },
        { "x": 357.4830212120367, "y": 405.07111678398286 },
        { "x": 354.85202942531834, "y": 386.6966767398182 },
        { "x": 354.28210345071085, "y": 373.525243320829 },
        { "x": 354.28210345071085, "y": 300.217167148954 },
        { "x": 355.54450784366855, "y": 294.13653130210076 },
        { "x": 370.931451362784, "y": 283.94854878760015 },
        { "x": 371.8058827475859, "y": 283.928544102079 },
        { "x": 652.2196034507108, "y": 283.928544102079 },
        { "x": 667.207064044888, "y": 291.7733856228653 },
        { "x": 669.7433827475859, "y": 300.217167148954 },
        { "x": 669.7433827475859, "y": 373.525243320829 },
        { "x": 669.3773709658933, "y": 384.0573870924774 },
        { "x": 667.0430367712331, "y": 402.4662743893925 },
        { "x": 662.6945483211828, "y": 420.5574018148247 },
        { "x": 656.4423530821157, "y": 438.1602120784584 },
        { "x": 648.3406397227598, "y": 455.09865821278726 },
        { "x": 638.3966333989454, "y": 471.1656982687775 },
        { "x": 626.5829759363485, "y": 486.09662038958703 },
        { "x": 612.8627297405553, "y": 499.54153783000146 },
        { "x": 597.2331346396757, "y": 511.038732895023 },
        { "x": 595.6779823569608, "y": 511.993993320829 },
        { "x": 610.0858750466657, "y": 522.1345778492752 },
        { "x": 624.1650653604818, "y": 535.2539253619972 },
        { "x": 636.3322683696103, "y": 549.9369819549385 },
        { "x": 646.6231633548093, "y": 565.8139584449592 },
        { "x": 655.0683557514501, "y": 582.6065225390258 },
        { "x": 661.6684950117422, "y": 600.0993128804031 },
        { "x": 666.3791748408628, "y": 618.1120945004287 },
        { "x": 669.101150823052, "y": 636.47508356846 },
        { "x": 669.7433827475859, "y": 650.4627433208291 },
        { "x": 669.7433827475859, "y": 723.770819492704 },
        { "x": 668.7890078548742, "y": 729.0842776683633 },
        { "x": 653.9719180588079, "y": 739.9783251074616 },
        { "x": 652.2129530600859, "y": 740.0594425395791 },
        { "x": 389.32966204446086, "y": 707.482196445829 },
        { "x": 634.6891737632109, "y": 707.482196445829 },
        { "x": 634.6891737632109, "y": 650.4627433208291 },
        { "x": 634.3399113540006, "y": 640.4734927800957 },
        { "x": 631.822796953137, "y": 622.088771381742 },
        { "x": 626.8484801177335, "y": 604.1424695638481 },
        { "x": 619.4186656598401, "y": 586.946121790773 },
        { "x": 609.5515382413221, "y": 570.8454834011856 },
        { "x": 597.2646330718351, "y": 556.2579207805458 },
        { "x": 582.5719539646459, "y": 543.7483990577522 },
        { "x": 565.5375125531508, "y": 534.1662901429 },
        { "x": 546.5000793461157, "y": 528.8349646714988 },
        { "x": 538.2984120444609, "y": 528.282616367704 },
        { "x": 527.433664334233, "y": 524.7735090640846 },
        { "x": 520.7746327475859, "y": 511.993993320829 },
        { "x": 521.258266818936, "y": 508.1786676732365 },
        { "x": 534.8845453981711, "y": 496.0144673971001 },
        { "x": 538.2984120444609, "y": 495.705370273954 },
        { "x": 554.6011026624991, "y": 493.56322277463113 },
        { "x": 572.8853336695983, "y": 486.26987535632287 },
        { "x": 588.963943791802, "y": 475.34273893511926 },
        { "x": 602.6603632096601, "y": 461.88752127564584 },
        { "x": 613.9440676693273, "y": 446.61374900615846 },
        { "x": 622.8012969021154, "y": 430.0127199379269 },
        { "x": 629.2127702955556, "y": 412.4652969328228 },
        { "x": 633.1654988054586, "y": 394.3005399195019 },
        { "x": 634.6704825286222, "y": 375.8200604406658 },
        { "x": 634.6891737632109, "y": 373.525243320829 },
        { "x": 634.6891737632109, "y": 316.50579019582904 },
        { "x": 389.32966204446086, "y": 316.50579019582904 },
        { "x": 389.32966204446086, "y": 373.525243320829 },
        { "x": 389.55035321157703, "y": 381.4761446503464 },
        { "x": 391.7992032591654, "y": 399.8910498408142 },
        { "x": 396.50186641257534, "y": 417.900435784227 },
        { "x": 403.6623205665899, "y": 435.19554115212594 },
        { "x": 413.2621172193838, "y": 451.43547774232064 },
        { "x": 425.2830514137102, "y": 466.21366987503205 },
        { "x": 439.7120123330904, "y": 478.98718658960496 },
        { "x": 456.49677996080646, "y": 488.94636652744447 },
        { "x": 475.3501746479822, "y": 494.8272067991558 },
        { "x": 485.7204237632109, "y": 495.705370273954 },
        { "x": 494.78217036765346, "y": 498.0503453103367 },
        { "x": 503.24420306008585, "y": 511.993993320829 },
        { "x": 503.1376368824793, "y": 513.7992859271827 },
        { "x": 491.25665963929424, "y": 527.452584722406 },
        { "x": 485.7204237632109, "y": 528.282616367704 },
        { "x": 471.54292343300114, "y": 529.9096963194671 },
        { "x": 453.0445558552099, "y": 536.7116893318954 },
        { "x": 436.70904679339657, "y": 547.3023142007652 },
        { "x": 422.74842209857235, "y": 560.5198344973388 },
        { "x": 411.1984625284029, "y": 575.6201065567794 },
        { "x": 402.0732733730627, "y": 592.0949485091033 },
        { "x": 395.3912219528509, "y": 609.5548007873359 },
        { "x": 391.16842280071506, "y": 627.6668493536773 },

        { "x": 389.3955806319071, "y": 646.1268038538758 },
        { "x": 389.32966204446086, "y": 650.4627433208291 },
        { "x": 389.32966204446086, "y": 708.482196445829 }
      ],
      [
        { "x": 686.3452954676297, "y": 470.2254293754593 },
        { "x": 335.82980718637975, "y": 470.2254293754593 },
        { "x": 327.3769743904022, "y": 468.9302205952899 },
        { "x": 312.56736344243564, "y": 457.1671157541768 },
        { "x": 309.5408130457548, "y": 445.78940398483434 },
        { "x": 309.5408130457548, "y": 413.20597625045934 },
        { "x": 312.2621513470558, "y": 402.38254266112006 },
        { "x": 326.74567639972247, "y": 390.2733617785469 },
        { "x": 335.82980718637975, "y": 388.76995085983435 },
        { "x": 686.3452954676297, "y": 388.76995085983435 },
        { "x": 703.9372299029974, "y": 395.0612233567134 },
        { "x": 712.5546083166746, "y": 411.2941422152416 },
        { "x": 712.6342896082547, "y": 413.20597625045934 },
        { "x": 712.6342896082547, "y": 445.78940398483434 },
        { "x": 712.4878771021513, "y": 448.37736911206406 },
        { "x": 703.3882398321775, "y": 464.3819098535077 },
        { "x": 344.59502203012977, "y": 437.6481832817093 },
        { "x": 677.5867310145047, "y": 437.6481832817093 },
        { "x": 677.5867310145047, "y": 421.35956023483436 },
        { "x": 344.59502203012977, "y": 421.35956023483436 },
        { "x": 344.59502203012977, "y": 437.6481832817093 },
        { "x": 686.3452954676297, "y": 942.6511325004593 },
        { "x": 335.82980718637975, "y": 942.6511325004593 },
        { "x": 328.6556646093277, "y": 941.72671613722 },
        { "x": 313.223086924806, "y": 930.6785804393784 },
        { "x": 309.5408130457548, "y": 918.2151071098343 },
        { "x": 309.5408130457548, "y": 885.6316793754594 },
        { "x": 311.6978788539318, "y": 875.9374437096611 },
        { "x": 325.50136655713595, "y": 863.1602672102944 },
        { "x": 335.82980718637975, "y": 861.1956539848344 },
        { "x": 686.3452954676297, "y": 861.1956539848344 },
        { "x": 702.9199847891477, "y": 866.6767544510857 },
        { "x": 712.4168026759771, "y": 882.4812521102921 },
        { "x": 712.6342896082547, "y": 885.6316793754594 },
        { "x": 712.6342896082547, "y": 918.2151071098343 },
        { "x": 712.5947525813726, "y": 919.5618898036972 },
        { "x": 704.3847430660871, "y": 935.9754586580292 },
        { "x": 686.3452954676297, "y": 942.6511325004593 },
        { "x": 344.59502203012977, "y": 910.0677047660844 },
        { "x": 677.5867310145047, "y": 910.0677047660844 },
        { "x": 677.5867310145047, "y": 893.7790817192093 },
        { "x": 344.59502203012977, "y": 893.7790817192093 },
        { "x": 344.59502203012977, "y": 910.0677047660844 }
      ]
    ]

    const width = 322
    const height = 472 

    const realHeight = containerHeight * 0.8
    const realWidth = width / height * realHeight

    const scaleX = realWidth / width
    const scaleY = realHeight / height

    const centerX = containerWidth / 2
    const centerY = containerHeight / 2
    
    // 161 236 
    // 322 472
    sandglassBody.current = Bodies.fromVertices(centerX , centerY, vertexSets, {
      isStatic: true,
      render: {
        fillStyle: '#060a19',
        strokeStyle: '#060a19',
        lineWidth: 1,
      }
    }, true)

    Body.scale(sandglassBody.current, scaleX, scaleY)
    Composite.add(WorldInstance.current!, sandglassBody.current)

    createWord({
      centerX,
      centerY,
      width: realWidth,
      height: realHeight,
      scale: scaleY
    })

  }, [])

  // init 
  useEffect(() => {
    const container = document.querySelector('#flag-getter-caontainer')
    const containerWidth = container?.clientWidth || 0
    const containerHeight = container?.clientHeight || 0
    clientSize.current = {
      width: containerWidth,
      height: containerHeight
    }
    // create engine
    EngineInstance.current = Engine.create()
    WorldInstance.current = EngineInstance.current!.world
    // create renderer
    RenderInstance.current = Render.create({
      canvas: document.querySelector('#flag-getter-canvas') as any,
      engine: EngineInstance.current,
      options: {
        width: containerWidth,
        height: containerHeight,
        wireframes: false,
        background: "transparent",
      },
    })
    Render.run(RenderInstance.current)
    // create runner
    RunnerInstance.current = Runner.create()
    Runner.run(RunnerInstance.current, EngineInstance.current)

    initExtraBody(containerWidth, containerHeight)

    let deg = 40 * Math.PI
    setInterval(() => {
      deg = -deg
      Body.rotate(sandglassBody.current!, deg)
    }, 1000)

  }, [])

  // useEffect(() => {
  //   if(clientSize.current.width && clientSize.current.height && !Number.isNaN(Number(clientX))) {
  //     console.log(222222222, sandglassBody.current, clientX)
  //     const center = clientSize.current.width / 2 
  //     const rest = center - clientX
  //     const deg = (rest / center) * 45 * Math.PI
  //     const prevDeg = sandglassBody.current!.angle
  //     Body.rotate(sandglassBody.current!, deg - prevDeg)
  //   }
  // }, [clientX])

  return (
    <div
      className="flag-getter-main"
    >
      <canvas id="flag-getter-canvas" />
    </div>
  )
}

function App() {

  return (
    <div id="flag-getter-caontainer">
      <GameCanvas />
    </div>
  )
}

export default App
